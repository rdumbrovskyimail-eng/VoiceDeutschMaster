name: Voice Deutsch Master CI (Fast Build)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: Fast Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    # ============================================================
    # ğŸ”¥ Ğ’Ğ Ğ•ĞœĞ•ĞĞĞ: ĞŸĞĞ›ĞĞĞ¯ ĞĞ§Ğ˜Ğ¡Ğ¢ĞšĞ ĞšĞ•Ğ¨Ğ•Ğ™
    # ============================================================
    - name: ğŸ”¥ Clear ALL caches (TEMPORARY)
      run: |
        echo "ğŸ—‘ï¸ Removing all Gradle caches..."
        rm -rf ~/.gradle/caches
        rm -rf ~/.gradle/wrapper
        rm -rf ~/.gradle/daemon
        rm -rf ~/.konan
        rm -rf .gradle
        rm -rf build
        rm -rf app/build
        echo "âœ… All caches cleared"
    # ============================================================

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-read-only: false
        gradle-home-cache-cleanup: true

    # Ğ—ĞĞšĞĞœĞœĞ•ĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ: ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
    # - name: Cache Gradle & Kotlin
    #   uses: actions/cache@v4
    #   with:
    #     path: |
    #       ~/.gradle/caches
    #       ~/.gradle/wrapper
    #       ~/.gradle/daemon
    #       ~/.konan
    #       .gradle
    #     key: ${{ runner.os }}-gradle-fast-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
    #     restore-keys: |
    #       ${{ runner.os }}-gradle-fast-
    #       ${{ runner.os }}-gradle-

    # Ğ—ĞĞšĞĞœĞœĞ•ĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ: ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
    # - name: Cache build outputs
    #   uses: actions/cache@v4
    #   with:
    #     path: |
    #       app/build/intermediates
    #       app/build/tmp
    #       build/kotlin
    #     key: ${{ runner.os }}-build-fast-${{ github.sha }}
    #     restore-keys: |
    #       ${{ runner.os }}-build-fast-

    # â”€â”€ Gradle wrapper: ensure gradlew + wrapper JAR exist â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Ensure Gradle wrapper exists
      run: |
        # Ensure gradlew is executable
        if [ -f "./gradlew" ]; then
          chmod +x gradlew
        fi
        
        # Download gradle-wrapper.jar if missing (not committed to repo)
        WRAPPER_JAR="gradle/wrapper/gradle-wrapper.jar"
        if [ ! -f "$WRAPPER_JAR" ]; then
          echo "gradle-wrapper.jar not found, downloading..."
          mkdir -p gradle/wrapper
          GRADLE_VERSION=$(grep -oP 'gradle-\K[0-9.]+' gradle/wrapper/gradle-wrapper.properties || echo "8.12")
          curl -sL "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip" -o /tmp/gradle.zip
          unzip -q -o /tmp/gradle.zip -d /tmp/gradle-extract
          cp /tmp/gradle-extract/gradle-${GRADLE_VERSION}/lib/gradle-wrapper-*.jar "$WRAPPER_JAR" 2>/dev/null || true
          # Fallback: download wrapper JAR directly from Gradle GitHub
          if [ ! -f "$WRAPPER_JAR" ]; then
            curl -sL "https://raw.githubusercontent.com/gradle/gradle/v${GRADLE_VERSION}/gradle/wrapper/gradle-wrapper.jar" -o "$WRAPPER_JAR"
          fi
          # Final fallback: generate via installed gradle
          if [ ! -f "$WRAPPER_JAR" ] || [ ! -s "$WRAPPER_JAR" ]; then
            echo "Direct download failed, generating wrapper..."
            gradle wrapper --gradle-version "$GRADLE_VERSION"
          fi
          rm -rf /tmp/gradle.zip /tmp/gradle-extract
          echo "âœ… gradle-wrapper.jar ready"
        fi
        
        # Generate gradlew if missing
        if [ ! -f "./gradlew" ]; then
          echo "gradlew not found, generating..."
          gradle wrapper --gradle-version 8.12
          chmod +x gradlew
        fi

    - name: Grant execute permission
      run: chmod +x gradlew

    # â”€â”€ Firebase: google-services.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Set up google-services.json
      run: |
        if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > app/google-services.json
          echo "âœ… Using google-services.json from secrets"
        elif [ -f "app/google-services.json.ci" ]; then
          cp app/google-services.json.ci app/google-services.json
          echo "âš ï¸ Using CI placeholder google-services.json"
        else
          echo "âŒ ERROR: No google-services.json available"
          exit 1
        fi

    - name: Create local.properties
      run: |
        cat > local.properties << EOF
        sdk.dir=$ANDROID_HOME
        EOF

    # â”€â”€ Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Fast Build Debug APK
      id: build
      run: |
        ./gradlew assembleDebug \
          --parallel \
          --build-cache \
          --configuration-cache \
          --max-workers=4 \
          --no-daemon \
          -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseParallelGC" \
          -Dkotlin.incremental=true \
          -Dkotlin.compiler.execution.strategy=in-process \
          -Pkotlin.daemon.jvmargs="-Xmx2g"
      continue-on-error: true

    - name: Extract critical errors
      if: failure()
      run: |
        echo "## âŒ Build Failed" > build_errors.txt
        ./gradlew assembleDebug --stacktrace 2>&1 | grep -A 5 "FAILURE\|error:" | head -50 >> build_errors.txt
        cat build_errors.txt

    # â”€â”€ Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Unit Tests (Optional)
      if: success() && github.event_name == 'pull_request'
      run: |
        ./gradlew testDebugUnitTest \
          --parallel \
          --build-cache \
          --configuration-cache \
          --continue
      continue-on-error: true

    - name: Lint Check (Optional)
      if: success() && github.event_name == 'pull_request'
      run: ./gradlew lintDebug --continue
      continue-on-error: true

    # â”€â”€ Artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-errors
        path: build_errors.txt
        retention-days: 1
        if-no-files-found: ignore

    - name: Upload Lint Results
      if: always() && github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: app/build/reports/lint-results-debug.html
        retention-days: 3
        if-no-files-found: ignore

    - name: Upload Test Results
      if: always() && github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 3
        if-no-files-found: ignore

    # â”€â”€ Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Create Release
      if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: VoiceDeutschMaster v1.0.${{ github.run_number }}
        body: |
          ## ğŸ“± VoiceDeutschMaster v1.0.${{ github.run_number }}
          
          **Debug Build** - Fast compilation for testing
          
          **Commit:** `${{ github.sha }}`
          **Build #:** ${{ github.run_number }}
          
          ### ğŸ“¦ Download
          Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ APK Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ¸Ğ¶Ğµ â¬‡ï¸
          
        files: app/build/outputs/apk/debug/*.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}