name: Deploy Firebase Functions & Rules

on:
  push:
    branches: [ main ]
    paths:
      - 'functions/**'
      - 'firestore.rules'
      - 'firestore.indexes.json'
      - 'storage.rules'
      - 'firebase.json'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: functions/package.json

    - name: Install Firebase CLI
      run: npm install -g firebase-tools

    - name: Install Functions dependencies
      working-directory: functions
      run: npm install --package-lock-if-needed

    - name: Deploy Functions, Firestore rules & Storage rules
      run: |
        printf '%s' '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > /tmp/sa.json
        GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.json \
        firebase deploy \
          --only functions,firestore,storage \
          --project ${{ secrets.FIREBASE_PROJECT_ID }} \
          --non-interactive

    - name: Clean up credentials
      if: always()
      run: rm -f /tmp/sa.json